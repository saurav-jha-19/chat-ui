<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>2-Side Chat Demo</title>
  <style>
    body { font-family: Arial; background:#f4f4f4; margin:0; }
    #chat { height: 80vh; overflow-y:auto; padding:10px; }
    .msg { margin:6px 0; padding:8px 10px; border-radius:6px; max-width:70%; }
    .user { background:#dcf8c6; margin-left:auto; }
    .agent { background:#fff; margin-right:auto; }
    #input { display:flex; padding:10px; background:#eee; }
    input { flex:1; padding:10px; }
    button { padding:10px 15px; }
  </style>
</head>
<body>

<div id="chat"></div>

<div id="input">
  <input id="msg" placeholder="Type message..." />
  <button onclick="sendMessage()">Send</button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* ðŸ”¥ STEP 1: Firebase config (APNA CONFIG DALO) */
const firebaseConfig = {
  apiKey: "XXXX",
  authDomain: "XXXX.firebaseapp.com",
  projectId: "XXXX",
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

/* ðŸ”¥ STEP 2: Anonymous login */
let currentUserId = null;
auth.signInAnonymously().then(res => {
  currentUserId = res.user.uid;
  startChat();
});

/* ðŸ”¥ STEP 3: FIXED CHAT ID (testing ke liye) */
const chatId = "demo-chat-1";   // dono browser me SAME rakho
const role = new URLSearchParams(location.search).get("role") || "user";

/* ðŸ”¥ STEP 4: Start chat + listen */
function startChat() {
  const messagesRef = db
    .collection("chats")
    .doc(chatId)
    .collection("messages")
    .orderBy("createdAt");

  messagesRef.onSnapshot(snapshot => {
    document.getElementById("chat").innerHTML = "";
    snapshot.forEach(doc => {
      const d = doc.data();
      const div = document.createElement("div");
      div.className = "msg " + d.sender;
      div.innerText = d.text;
      document.getElementById("chat").appendChild(div);
    });
  });
}

/* ðŸ”¥ STEP 5: Send message */
function sendMessage() {
  const text = document.getElementById("msg").value;
  if (!text) return;

  db.collection("chats")
    .doc(chatId)
    .collection("messages")
    .add({
      sender: role,          // "user" or "agent"
      senderId: currentUserId,
      text: text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

  document.getElementById("msg").value = "";
}
</script>

</body>
</html>
