<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Product Chat</title>

<style>
body{margin:0;font-family:Arial;background:#ece5dd;}
#header{
  display:flex;align-items:center;gap:10px;
  padding:10px;background:#075e54;color:#fff;
}
#header img{width:42px;height:42px;border-radius:50%;object-fit:cover}
#chat{height:78vh;overflow-y:auto;padding:10px}
.msg{max-width:70%;margin:6px 0;padding:8px 12px;border-radius:7px}
.user{background:#dcf8c6;margin-left:auto}
.agent{background:#fff;margin-right:auto}
#input{display:flex;padding:8px;background:#f0f0f0}
input{flex:1;padding:10px}
button{padding:10px}
</style>
</head>

<body>

<div id="header">
  <img id="productImage">
  <div>
    <div id="productTitle">Loadingâ€¦</div>
    <div style="font-size:12px;opacity:.8">online</div>
  </div>
</div>

<div id="chat"></div>

<div id="input">
  <input id="msg" placeholder="Type messageâ€¦" />
  <button onclick="send()">Send</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// ðŸ”¥ FIREBASE CONFIG (APNA DALO)
firebase.initializeApp({
  apiKey: "XXXX",
  authDomain: "XXXX.firebaseapp.com",
  projectId: "XXXX"
});

const auth = firebase.auth();
const db = firebase.firestore();

// ðŸ”¹ URL PARAMS
const q = new URLSearchParams(location.search);
const handle = q.get("handle");
const role = q.get("role") || "user";
if(!handle) document.body.innerHTML="âŒ No product";

// ðŸ”¹ CHAT ID = PRODUCT HANDLE
const chatId = handle;

// ðŸ”¹ LOGIN
let uid=null;
auth.signInAnonymously().then(r=>{
  uid=r.user.uid;
  loadProduct();
  listenChat();
});

// ðŸ”¹ LOAD PRODUCT (SHOPIFY)
fetch("https://yagnamart.myshopify.com/api/2023-10/graphql.json",{
 method:"POST",
 headers:{
  "Content-Type":"application/json",
  "X-Shopify-Storefront-Access-Token":"STOREFRONT_TOKEN"
 },
 body:JSON.stringify({
  query:`{productByHandle(handle:"${handle}"){title images(first:1){edges{node{url}}}}}`
 })
})
.then(r=>r.json())
.then(d=>{
 const p=d.data.productByHandle;
 document.getElementById("productTitle").innerText=p.title;
 document.getElementById("productImage").src=p.images.edges[0].node.url;
});

// ðŸ”¹ LISTEN CHAT
function listenChat(){
 const ref=db.collection("chats").doc(chatId)
   .collection("messages").orderBy("createdAt");

 ref.onSnapshot(s=>{
  chat.innerHTML="";
  s.forEach(doc=>{
    const m=doc.data();
    const div=document.createElement("div");
    div.className="msg "+m.senderRole;
    div.innerText=m.text;
    chat.appendChild(div);
  });
  chat.scrollTop=chat.scrollHeight;
 });
}

// ðŸ”¹ SEND MESSAGE
function send(){
 const t=msg.value.trim();
 if(!t) return;
 db.collection("chats").doc(chatId)
  .collection("messages").add({
    text:t,
    senderRole:role,
    senderId:uid,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
 msg.value="";
}
</script>

</body>
</html>
