<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Product Chat</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #ece5dd;
}

/* HEADER */
.header {
  display: flex;
  align-items: center;
  padding: 10px;
  background: #075e54;
  color: white;
}
.header img {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  margin-right: 10px;
  object-fit: cover;
}
.header .info {
  display: flex;
  flex-direction: column;
}
.header .name {
  font-weight: bold;
  font-size: 16px;
}
.header .status {
  font-size: 12px;
  opacity: 0.8;
}

/* CHAT */
.chat {
  padding: 15px;
  height: calc(100vh - 120px);
  overflow-y: auto;
}

/* MESSAGE */
.msg {
  max-width: 70%;
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 8px;
  font-size: 14px;
  line-height: 1.4;
  clear: both;
}
.left { background: #fff; float: left; }
.right { background: #dcf8c6; float: right; }

/* INPUT */
.input-box {
  display: flex;
  padding: 10px;
  background: #f0f0f0;
}
.input-box input {
  flex: 1;
  padding: 10px;
  border-radius: 20px;
  border: none;
  outline: none;
}
.input-box button {
  margin-left: 10px;
  padding: 10px 15px;
  border: none;
  background: #25d366;
  color: white;
  border-radius: 50%;
  cursor: pointer;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <img id="profilePic" src="https://via.placeholder.com/100">
  <div class="info">
    <div class="name" id="profileName">Loading...</div>
    <div class="status">online</div>
  </div>
</div>

<!-- CHAT -->
<div class="chat" id="chatBox">
  <div class="msg left">Namaste üôè kaise madad kar sakta hoon?</div>
</div>

<!-- INPUT -->
<div class="input-box">
  <input id="msgInput" placeholder="Type a message..." />
  <button onclick="sendMsg()">‚û§</button>
</div>

<!-- üî• FIREBASE SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// ===============================
// üî• FIREBASE CONFIG (APNA DALO)
// ===============================
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

// ===============================
// URL PARAMS
// ===============================
const params = new URLSearchParams(window.location.search);
const handle = params.get("handle");
const role = params.get("role") === "agent" ? "agent" : "user";

if (!handle) {
  document.getElementById("profileName").innerText = "No product selected";
  throw new Error("Product handle missing");
}

// ===============================
// CHAT ID (PRODUCT BASED)
// ===============================
const chatId = "product_" + handle;
let uid = null;

// ===============================
// AUTH + START LISTENER
// ===============================
auth.signInAnonymously().then(res => {
  uid = res.user.uid;
  listenMessages();
});

// ===============================
// FETCH SHOPIFY PRODUCT (NO TOKEN)
// ===============================
fetch(`https://www.yagnamart.com/products/${handle}.js`)
  .then(r => r.json())
  .then(p => {
    document.getElementById("profileName").innerText = p.title;
    if (p.featured_image) {
      document.getElementById("profilePic").src =
        p.featured_image.startsWith("//")
          ? "https:" + p.featured_image
          : p.featured_image;
    }
  });

// ===============================
// SEND MESSAGE
// ===============================
function sendMsg() {
  const input = document.getElementById("msgInput");
  if (!input.value.trim()) return;

  db.collection("chats")
    .doc(chatId)
    .collection("messages")
    .add({
      text: input.value,
      senderRole: role,
      senderId: uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

  input.value = "";
}

// ===============================
// LISTEN MESSAGES (REALTIME)
// ===============================
function listenMessages() {
  db.collection("chats")
    .doc(chatId)
    .collection("messages")
    .orderBy("createdAt")
    .onSnapshot(snap => {
      document.getElementById("chatBox").innerHTML = "";

      snap.forEach(doc => {
        const d = doc.data();
        const div = document.createElement("div");
        div.className = "msg " + (d.senderRole === "user" ? "right" : "left");
        div.innerText = d.text;
        document.getElementById("chatBox").appendChild(div);
      });

      document.getElementById("chatBox").scrollTop =
        document.getElementById("chatBox").scrollHeight;
    });
}
</script>

</body>
</html>
